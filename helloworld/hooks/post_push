#!/bin/bash
set -e

# Docker Hub client version is: 17.06.2-ee-6
# Use a newer cli version (18.09.0) in order to use
# experimental features (docker manifest):
docker18()
{
  # Convert environment variable into config file
  configfile="/root/.docker/config.json"
  [ -d $(dirname "${configfile}") ] || mkdir -p $(dirname "${configfile}")
  echo "${DOCKERCFG}" > "${configfile}"
  echo "[DEBUG] Docker config file ${configfile}:"
  cat "${configfile}"
  
  docker run --rm \
  -e DOCKER_CLI_EXPERIMENTAL=enabled \
  -e DOCKER_HOST=unix:///var/run/docker.sock \
  -e DOCKERCFG="${DOCKERCFG}" \
  -e DOCKER_CONFIG="/root/.docker" \
  -v "${configfile}":"${configfile}" \
  -v /var/run/docker.sock:/var/run/docker.sock docker "$@"
  
  # Remove config file
  rm ~/.docker/config.json
}

# Read image metadata from labels
VERSION=`docker inspect -f "{{ index .Config.Labels \"org.label-schema.schema-version\" }}" "${IMAGE_NAME}"`

# Parse IMAGE_NAME, as CACHE_TAG is broken on Docker Hub post_push
#IFS=: read CURRENT_REPO CURRENT_TAG <<< $IMAGE_NAME

echo "---------- DEBUG -----------"
echo "Docker Hub environment variables:"
echo "IMAGE_NAME: $IMAGE_NAME"
echo "DOCKER_REPO: $DOCKER_REPO"
echo "DOCKER_TAG: $DOCKER_TAG"
echo "CACHE_TAG: $CACHE_TAG"
echo "Custom variables:"
echo "VERSION: $VERSION"
echo "----------------------------"

ARCH=${DOCKER_TAG}
# Tag and push image for each additional tag
for TAG in {"${ARCH}-latest","${ARCH}-${VERSION}"}; do
  echo "Tag: ${DOCKER_REPO}:${TAG}"
  docker tag "$IMAGE_NAME" "${DOCKER_REPO}:${TAG}"
  docker push "${DOCKER_REPO}:${TAG}"
done


# docker manifest requires image name (without url) as an argument
IFS='/' read URL USERNAME IMAGE_NAME <<< "$IMAGE_NAME"
# Above line will split the IMAGE_NAME as:
# URL=index.docker.io
# USERNAME=xezpeleta
# IMAGE_NAME=helloworld:arm32v7
IFS=':' read IMAGE_NAME TAG <<< "$IMAGE_NAME"
# Above line will split the IMAGE_NAME as:
# IMAGE_NAME = helloworld
# TAG = arm32v7

# Create manifest list
# TODO: only after building all the tags (?)
# Build a multi-arch manifest
docker18 manifest create --amend ${IMAGE_NAME}:${VERSION} \
  ${IMAGE_NAME}:amd64-${VERSION} ${IMAGE_NAME}:arm32v7-${VERSION}
docker18 manifest create --amend ${IMAGE_NAME}:latest \
  ${IMAGE_NAME}:amd64-${VERSION} ${IMAGE_NAME}:arm32v7-${VERSION}

docker18 manifest annotate ${IMAGE_NAME}:${VERSION} \
  ${IMAGE_NAME}:amd64-${VERSION} --os linux --arch amd64
docker18 manifest annotate ${IMAGE_NAME}:${VERSION} \
  ${IMAGE_NAME}:arm32v7-${VERSION} --os linux --arch arm --variant 7

docker18 manifest push ${IMAGE_NAME}:${VERSION}
docker18 manifest push --purge ${IMAGE_NAME}:latest